<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Repository</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- IAAC Design System -->
  <link rel="stylesheet" href="/iaac-repo/design-system/design-system.css" />

  <style>
    /* ---------- page tweaks ---------- */
    body { margin:0; background:#E24E36; }
    header.hero {
      background:#E24E36; color:#fff;
      padding: var(--space-lg) var(--space-md);
    }
    header.hero .content { max-width:1200px; }
    header h1 {
      font-family: var(--font-display, 'Abril Fatface', serif);
      font-weight:400; color:#fff;
      font-size: clamp(2.1rem, 4vw, 3rem);
      margin:.2rem 0 .4rem;
    }
    header p { max-width:64ch; color:#fff; opacity:.95; }

    main .content { max-width:1200px; }

    .controls {
      display:grid;
      grid-template-columns: 260px 1fr 140px;
      gap: var(--space-md);
      align-items:center;
      margin: var(--space-md) 0 var(--space-lg);
    }
    @media (max-width:900px){
      .controls{ grid-template-columns: 1fr; }
    }

    select, input[type="search"]{
      padding: .7rem .8rem;
      border-radius: 8px;
      border:1px solid var(--color-border);
      font: inherit;
      background:#fff;
    }
    .count { text-align:right; opacity:.7; }
    @media (max-width:900px){ .count{ text-align:left; } }

    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-lg); }
    @media (max-width:1024px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:640px){ .grid{ grid-template-columns: 1fr; } }

    .card {
      background: #fff;
      border-radius: var(--radius-card);
      border:1px solid var(--color-border);
      box-shadow: 0 2px 12px var(--color-shadow);
      overflow: hidden;
      display:flex; flex-direction:column;
      padding: 16px;
    }
    .card-body { display:flex; flex-direction:column; gap: 8px; }
    .badge {
      display:inline-block; padding:.25rem .6rem; border-radius:999px;
      font-size:.75rem; font-weight:700; background:#4B7AFF; color:#fff;
      border: none;
      width: fit-content;
    }
    .title { font-weight:700; font-size:1.25rem; margin:0; line-height:1.3; }
    .card-actions { margin-top:auto; }
    .primary-btn { width:100%; text-align:center; }
    .empty { opacity:.7; padding:2rem 0; }
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="content">
      <h1>Repository</h1>
      <p>
        Browse all deliverables I’ve created across courses. Use the filter to switch
        between courses; each card links to the corresponding page.
      </p>
    </div>
  </header>

  <!-- GALLERY -->
  <main>
    <div class="content">

      <div class="controls">
        <select id="courseFilter" aria-label="Filter by course">
          <!-- options injected by JS -->
        </select>

        <input id="searchBox" type="search" placeholder="Search titles or tags…" aria-label="Search">

        <div class="count" id="resultCount">0 items</div>
      </div>

      <div id="gallery" class="grid" aria-live="polite"></div>
      <div id="emptyState" class="empty" hidden>No items match your filter.</div>

    </div>
  </main>

  <script>
    /* ========== Dynamic course loading ========== */
    const COURSES_DIR = '/iaac-repo/repository/courses/';
    const COURSES = [
      'Fundamentals for Future Makers',
      'living with your own ideas',
      'other species',
      'studio 0',
      'studio 1',
      'unpacking tech system'
    ];

    let deliverables = [];

    // Load all deliverables from course folders
    async function loadDeliverables() {
      const promises = [];

      for (const courseName of COURSES) {
        const encodedCourse = encodeURIComponent(courseName);
        const courseUrl = `${COURSES_DIR}${encodedCourse}/`;

        // Only include specific end-page files that are direct children of course folders
        const files = ['index.html', 'prototype 1.html', 'prototype 2.html', 'prototype 3.html', 
                       'summary report.html', 'course reflection.html', 'cottage-industry.html',
                       'design bet.html', 'the log.html',
                       'Action Dossier.html', 'emboded criticism.html',
                       'problem statement.html', 'Week 1 Reflection.html', 'Week 2 Reflection.html'];

        for (const file of files) {
          const fileUrl = courseUrl + encodeURIComponent(file);
          const promise = fetch(fileUrl, { method: 'HEAD' })
            .then(response => {
              if (response.ok && response.status === 200) {
                // File exists, now fetch title
                return fetch(fileUrl)
                  .then(r => r.text())
                  .then(html => {
                    const titleMatch = html.match(/<title>([^<]+)<\/title>/i);
                    const title = titleMatch ? titleMatch[1] : null;
                    if (title && title !== 'Untitled') {
                      return {
                        title: title,
                        course: courseName,
                        href: fileUrl.replace(encodeURIComponent(file), file),
                        fileName: file
                      };
                    }
                    return null;
                  })
                  .catch(() => null);
              }
              return null;
            })
            .catch(() => null);
          promises.push(promise);
        }
      }

      const results = await Promise.all(promises);
      deliverables = results.filter(d => d !== null);
      
      initializeUI();
    }

    /* ========== UI wiring ========== */
    function initializeUI() {
      const galleryEl = document.getElementById('gallery');
      const courseFilterEl = document.getElementById('courseFilter');
      const searchBoxEl = document.getElementById('searchBox');
      const resultCountEl = document.getElementById('resultCount');
      const emptyEl = document.getElementById('emptyState');

      // Build distinct course list + query param support
      const urlParams = new URLSearchParams(location.search);
      const qpCourse = (urlParams.get('course') || '').toLowerCase();

      const courses = Array.from(new Set(deliverables.map(d => d.course.toLowerCase()))).sort();
      courseFilterEl.innerHTML = [
        `<option value="all">All courses</option>`,
        ...courses.map(c => `<option value="${c}">${titleCase(c)}</option>`)
      ].join('');
      if (qpCourse && courses.includes(qpCourse)) courseFilterEl.value = qpCourse;

      // Render
      function render() {
        const q = searchBoxEl.value.trim().toLowerCase();
        const selected = courseFilterEl.value;

        const filtered = deliverables.filter(d => {
          const matchesCourse = selected === 'all' || d.course.toLowerCase() === selected;
          const hay = [d.title, d.fileName].join(' ').toLowerCase();
          const matchesSearch = !q || hay.includes(q);
          return matchesCourse && matchesSearch;
        });

        galleryEl.innerHTML = filtered.map(cardHTML).join('');
        resultCountEl.textContent = `${filtered.length} item${filtered.length!==1?'s':''}`;
        emptyEl.hidden = filtered.length !== 0;
      }

      function cardHTML(d){
        return `
          <article class="card">
            <div class="card-body">
              <span class="badge">${titleCase(d.course)}</span>
              <h3 class="title">${escapeHTML(d.title)}</h3>
              <div class="card-actions">
                <a class="primary-btn" href="${d.href}">Open</a>
              </div>
            </div>
          </article>`;
      }

      function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
      function titleCase(s){ return s.replace(/\b\w/g, c => c.toUpperCase()); }

      // Events
      courseFilterEl.addEventListener('change', () => {
        const v = courseFilterEl.value;
        const p = new URLSearchParams(location.search);
        if (v==='all') { p.delete('course'); } else { p.set('course', v); }
        history.replaceState({}, '', `${location.pathname}?${p.toString()}`);
        render();
      });
      searchBoxEl.addEventListener('input', render);

      // Initial render
      render();
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadDeliverables);
  </script>
</body>
</html>
